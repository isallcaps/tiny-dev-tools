<app-tool-layout [tool]="tool">
	<div class="row g-4">

		<!-- ===================== -->
		<!-- Left: CSV configuration -->
		<!-- ===================== -->
		<!-- ===================== -->
		<!-- Left: CSV configuration (collapsible) -->
		<!-- ===================== -->
		<div class="col-12 col-lg-6">
			<div class="card h-100">

				<!-- Card header with toggle -->
				<div class="card-header d-flex justify-content-between align-items-center">
					<h2 class="h6 mb-0">CSV configuration</h2>

					<button
							type="button"
							class="btn btn-sm btn-link text-decoration-none"
							(click)="toggleConfig()">
						@if (showConfig) {
							Hide
						} @else {
							Show
						}
					</button>
				</div>

				<!-- Only show body when expanded -->
				@if (showConfig) {
					<div class="card-body">
						<p class="text-muted small">
							Paste a CSV with
							<code>jiraField,jiraValue,description,group</code>
							as the header row, or upload a CSV file.
							Values are stored locally in your browser.
						</p>

						<!-- File upload -->
						<div class="mb-2 d-flex align-items-center gap-2">
							<label class="btn btn-outline-secondary btn-sm mb-0">
								Upload CSV
								<input
										type="file"
										accept=".csv,text/csv"
										class="d-none"
										(change)="onFileSelected($event)"/>
							</label>

							@if (csvFileName) {
								<span class="text-muted small">
							Loaded: {{ csvFileName }}
						</span>
							}
						</div>

						<!-- CSV textarea -->
						<textarea
								class="form-control mb-2 font-monospace"
								rows="6"
								[(ngModel)]="csvInput"
								placeholder="jiraField,jiraValue,description,group&#10;project,Dev-1234,Dev ToolKit,&#10;component,Core,,&#10;labels,Home,,UI Screen&#10;labels,App,,UI Screen&#10;Epic Link,Dev-9834,Initial Setup,">
				</textarea>

						<!-- Actions -->
						<div class="d-flex justify-content-between align-items-center mt-2">
							<button
									type="button"
									class="btn btn-outline-danger btn-sm"
									(click)="clearLocalConfig()">
								Clear local config
							</button>

							<button
									type="button"
									class="btn btn-outline-primary btn-sm"
									(click)="onApplyCsv()">
								Apply CSV
							</button>
						</div>

						@if (fieldKeys.length) {
							<hr class="my-3"/>
							<p class="text-muted small mb-0">
								Loaded configuration for {{ fieldKeys.length }} Jira fields.
							</p>
						}
					</div>
				}
			</div>
		</div>


		<!-- ===================== -->
		<!-- Right: Values + JQL -->
		<!-- ===================== -->
		<div class="col-12 col-lg-6">
			<div class="card h-100">
				<div class="card-body d-flex flex-column">
					<h2 class="h5 fw-semibold mb-3">Values &amp; JQL</h2>

					@if (fieldKeys.length) {

						<!-- Grouped values -->
						<div class="mb-3" style="max-height: 260px; overflow-y: auto;">
							@for (field of fieldKeys; track field) {
								<div class="mb-3 border-bottom pb-2">
									<h3 class="fw-light fs-5 mb-2">
										{{ field }}
									</h3>

									@for (groupName of groupKeys(field); track groupName) {
										<div class="mb-2">

											@if (!(groupName === 'General' && groupKeys(field).length === 1)) {
												<h4 class="fs-6 mb-1">
													{{ groupName }}:
												</h4>
											}

											@for (item of grouped[field][groupName]; track item.jiraValue) {
												<div class="form-check">
													<input
															type="checkbox"
															class="form-check-input"
															id="cb_{{ field }}_{{ item.jiraValue }}"
															[checked]="isSelected(field, item.jiraValue)"
															(change)="toggleSelection(
															field,
															item.jiraValue,
															$any($event.target).checked
														)"/>

													<label
															class="form-check-label"
															for="cb_{{ field }}_{{ item.jiraValue }}">
														<span class="fw-bold font-monospace">
															{{ item.jiraValue }}
														</span>
														@if (item.description) {
															<span class="fw-light text-secondary">
																- {{ item.description }}
															</span>
														}
													</label>
												</div>
											}
										</div>
									}
								</div>
							}
						</div>

						<!-- Generated / editable query -->
						<h3 class="h6 fw-semibold mt-2">
							Generated JQL (editable)
						</h3>

						@if (jql) {
							<textarea
									class="form-control font-monospace mb-2"
									rows="5"
									[(ngModel)]="manualQuery">
							</textarea>

							<div class="d-flex justify-content-between align-items-center">
								<button
										type="button"
										class="btn btn-outline-secondary btn-sm"
										(click)="resetQuery()">
									Reset query
								</button>

								<app-copy-to-clipboard-btn
										[textToCopy]="manualQuery || jql">
								</app-copy-to-clipboard-btn>
							</div>
						} @else {
							<p class="text-muted">
								Select at least one value to generate a JQL query.
							</p>
						}

					} @else {
						<p class="text-muted">
							Paste or upload a CSV on the left and click
							<strong>Apply CSV</strong> to get started.
						</p>
					}
				</div>
			</div>
		</div>

	</div>
</app-tool-layout>
